<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ëà™Á©∫Â∑•Á®ãÂ∏´ÊãõÂãüÁâπË®ì</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Â∑•Ê•≠È¢®ÈÖçËâ≤ÔºöËóçÂúñËóç„ÄÅË≠¶Á§∫ÈªÉ„ÄÅÊ©üÊ¢∞ÁÅ∞ */
            --sidebar-bg: #2c3e50; 
            --sidebar-text: #bdc3c7;
            --main-bg: #f4f7f6;
            --exam-color: #34495e; 
            --interview-color: #d35400; 
            --accent: #f39c12;
            --text: #2c3e50;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: var(--main-bg); color: var(--text);
        }

        .layout { display: flex; width: 100%; height: 100%; position: relative; }
        .overlay-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; display: none; }

        /* Sidebar */
        .sidebar {
            width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text);
            display: flex; flex-direction: column; padding: 0; flex-shrink: 0;
            z-index: 100; transition: transform 0.3s ease;
            overflow-y: auto;
        }
        .sidebar-header { 
            padding: 25px 20px; text-align: center; font-weight: bold; font-size: 1.1rem; 
            color: #fff; border-bottom: 1px solid #465c6f; background: #243342;
        }
        .section-title {
            padding: 15px 20px 5px; font-size: 0.75rem; text-transform: uppercase; 
            color: #7f8c8d; font-weight: bold; margin-top: 10px;
        }
        .nav-item { 
            padding: 12px 20px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; 
            font-size: 0.95rem; display: flex; align-items: center; 
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: #fff; font-weight: bold; }
        .nav-item.exam-active { border-left-color: var(--accent); }
        .nav-item.interview-active { border-left-color: var(--interview-color); }
        
        .api-area { padding: 20px; margin-top: auto; border-top: 1px solid #465c6f; }
        .api-input { width: 100%; padding: 10px; border-radius: 4px; border: none; background: #1a252f; color: white; border: 1px solid #465c6f; }

        /* Main Content */
        .main-content {
            flex: 1; display: flex; flex-direction: column; width: 100%;
            position: relative; overflow: hidden;
        }
        
        .top-bar {
            background: #fff; height: 60px; padding: 0 20px;
            border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .menu-btn { display: none; font-size: 24px; cursor: pointer; border: none; background: none; color: #333; margin-right: 10px; }
        .mode-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; color: white; margin-left: 10px; }

        /* Scroll Container */
        .scroll-container {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 20px; padding-bottom: 80px;
        }

        /* Exam Grid */
        .drill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .drill-card {
            background: white; border-radius: 8px; padding: 20px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid transparent;
            display: flex; flex-direction: column; justify-content: space-between; height: 100px;
            transition: transform 0.2s;
        }
        .drill-card:hover { transform: translateY(-3px); border-top-color: var(--accent); }
        .progress-bar-bg { width: 100%; height: 4px; background: #eee; margin-top: auto; border-radius: 2px; overflow:hidden; }
        .progress-bar-fill { height: 100%; background: #27ae60; width: 0%; }

        /* Interview View */
        .interview-view { max-width: 800px; margin: 0 auto; display: none; }
        .question-card {
            background: white; border-radius: 8px; padding: 30px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid var(--interview-color);
        }
        .q-text { font-size: 1.3rem; font-weight: bold; margin: 20px 0; color: #333; }
        .action-btn {
            background: var(--exam-color); color: white; border: none; padding: 12px 25px;
            border-radius: 30px; font-size: 1rem; cursor: pointer; font-weight: bold;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .action-btn.interview-btn { background: var(--interview-color); }
        
        .answer-section { background: white; border-radius: 8px; padding: 20px; display: none; margin-top: 20px; }
        .input-box { width: 100%; height: 150px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; margin-bottom: 10px; font-size: 1rem; box-sizing: border-box; }
        .feedback-box { background: #fff; border-left: 4px solid var(--accent); padding: 20px; margin-top: 20px; display: none; line-height: 1.6; white-space: pre-wrap; }

        /* Overlays */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: none;
            justify-content: center; align-items: center; z-index: 200; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--exam-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8f9fa; z-index: 200; display: none; flex-direction: column;
        }
        .quiz-overlay.active { display: flex; animation: slideUp 0.3s ease-out; }
        .quiz-header { padding: 0 20px; height: 60px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .quiz-body { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
        .q-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .opt-btn { width: 100%; text-align: left; padding: 14px; margin-bottom: 10px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; }
        .opt-btn.correct { background: #d4edda; border-color: #27ae60; }
        .opt-btn.wrong { background: #f8d7da; border-color: #c0392b; }
        .explanation { background: #e8f4fd; padding: 15px; margin-top: 10px; border-radius: 6px; display: none; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; left: -260px; top: 0; }
            .sidebar.open { transform: translateX(260px); }
            .overlay-backdrop.open { display: block; }
            .menu-btn { display: block; }
        }
    </style>
</head>
<body>

<div class="layout">
    <div class="overlay-backdrop" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">üõ†Ô∏è Â∑•Á®ãÂ∏´ÊãõÂãüÁâπË®ì</div>
        
        <div class="section-title">üìù ÊãõÂãüÁ≠ÜË©¶ (Aptitude)</div>
        <div class="nav-item exam-active active" onclick="switchMode('exam', 'Áâ©ÁêÜ', this)">Áâ©ÁêÜ (Physics)</div>
        <div class="nav-item exam-active" onclick="switchMode('exam', 'Êï∏Â≠∏', this)">Êï∏Â≠∏ (Math)</div>
        <div class="nav-item exam-active" onclick="switchMode('exam', 'ÈÇèËºØÊ∏¨È©ó', this)">ÈÇèËºØ (Logic)</div>
        <div class="nav-item exam-active" onclick="switchMode('exam', 'Ëà™Á©∫Ëã±Êñá', this)">Ëã±Êñá (English)</div>

        <div class="section-title">üéôÔ∏è ÊãõÂãüÈù¢Ë©¶ (Interview)</div>
        <div class="nav-item interview-active" onclick="switchMode('interview', 'General', this)">ÂÄã‰∫∫ÁâπË≥™ (HR)</div>
        <div class="nav-item interview-active" onclick="switchMode('interview', 'Technical', this)">Á∂≠‰øÆËßÄÂøµ (Tech)</div>
        <div class="nav-item interview-active" onclick="switchMode('interview', 'English', this)">Ëã±ÊñáÂè£Ë™™ (Speaking)</div>

        <div class="api-area">
            <label style="color:#7f8c8d; font-size:0.8rem; font-weight:bold;">API Key</label>
            <input type="password" id="api-key" class="api-input" placeholder="sk-..." onchange="saveKey()">
        </div>
    </aside>

    <main class="main-content" id="main-content">
        <div class="top-bar">
            <div style="display:flex; align-items:center;">
                <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <div>
                    <h3 id="top-title" style="margin:0; font-size:1.1rem; display:inline-block;">Áâ©ÁêÜ</h3>
                    <span id="mode-badge" class="mode-badge" style="background:var(--exam-color)">Á≠ÜË©¶Ê®°Âºè</span>
                </div>
            </div>
        </div>

        <div class="scroll-container">
            <!-- 1. Á≠ÜË©¶‰ªãÈù¢ -->
            <div id="exam-view" style="display:block;">
                <div id="drill-list" class="drill-grid"></div>
            </div>

            <!-- 2. Èù¢Ë©¶‰ªãÈù¢ -->
            <div id="interview-view" class="interview-view" style="display:none;">
                <div class="question-card">
                    <div style="color:#999; font-size:0.9rem; margin-bottom:10px;">INTERVIEW SIMULATION</div>
                    <div class="q-text" id="interview-q-text">Ê∫ñÂÇôÂ•ΩÊé•ÂèóÂ∑•Á®ãÂ∏´Èù¢Ë©¶ÊåëÊà∞‰∫ÜÂóéÔºü</div>
                    <button class="action-btn interview-btn" onclick="generateInterviewQ()">üé≤ ÊäΩÂèñÈù¢Ë©¶È°å</button>
                </div>

                <div id="interview-answer-box" class="answer-section">
                    <h4 style="margin-top:0;">Answer Draft</h4>
                    <textarea id="interview-input" class="input-box" placeholder="Write your answer here..."></textarea>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn interview-btn" onclick="analyzeInterview()">‚ú® Êèê‰∫§ÂàÜÊûê</button>
                    </div>
                    <div id="interview-feedback" class="feedback-box"></div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-text" style="margin-top:20px; font-weight:bold; color:#555;">AI Ê≠£Âú®Âá∫È°å‰∏≠...</p>
        </div>

        <!-- Quiz Overlay -->
        <div id="quiz-overlay" class="quiz-overlay">
            <div class="quiz-header">
                <h3 id="quiz-title">Ê∏¨È©ó</h3>
                <button onclick="closeOverlay('quiz-overlay')" style="font-size:1.5rem; background:none; border:none;">‚úï</button>
            </div>
            <div id="quiz-body" class="quiz-body"></div>
        </div>

    </main>
</div>

<script>
    // State
    let appState = { mode: 'exam', target: 'Áâ©ÁêÜ' };
    let dataStore = { examCache: {} };
    const STORAGE_KEY = 'airline_recruit_data';

    window.onload = function() {
        const key = localStorage.getItem('jlpt_api_key');
        if(key) document.getElementById('api-key').value = key;
        const savedData = localStorage.getItem(STORAGE_KEY);
        if(savedData) dataStore = JSON.parse(savedData);
        renderContent();
    }

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(dataStore)); }
    function saveKey() { localStorage.setItem('jlpt_api_key', document.getElementById('api-key').value.trim()); }
    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.overlay-backdrop').classList.toggle('open');
    }

    // Switch Logic
    function switchMode(mode, target, btn) {
        appState.mode = mode;
        appState.target = target;
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');

        document.getElementById('top-title').innerText = target;
        const badge = document.getElementById('mode-badge');
        badge.innerText = (mode === 'exam') ? 'Á≠ÜË©¶Ê®°Âºè' : 'Èù¢Ë©¶Ê®°Âºè';
        badge.style.background = (mode === 'exam') ? 'var(--exam-color)' : 'var(--interview-color)';
        
        renderContent();
        if(window.innerWidth <= 768) toggleSidebar();
    }

    function renderContent() {
        const examView = document.getElementById('exam-view');
        const interviewView = document.getElementById('interview-view');

        if (appState.mode === 'exam') {
            interviewView.style.display = 'none';
            examView.style.display = 'block';
            renderExamDrills();
        } else {
            examView.style.display = 'none';
            interviewView.style.display = 'block';
            document.getElementById('interview-answer-box').style.display = 'none';
            document.getElementById('interview-q-text').innerText = "ÈªûÊìäÊåâÈàïÊäΩÂèñÈ°åÁõÆ...";
        }
    }

    // --- Exam Logic ---
    function renderExamDrills() {
        const container = document.getElementById('drill-list');
        container.innerHTML = '';
        for(let i=1; i<=10; i++) {
            const cacheId = `${appState.target}-${i}`;
            const data = dataStore.examCache[cacheId];
            let progress = 0;
            let status = "Êú™ÈñãÂßã";
            if (data) {
                const answered = data.q.filter(q => q.userAns !== undefined).length;
                progress = (answered / 10) * 100;
                status = progress === 100 ? "ÂÆåÊàê" : `${answered}/10`;
            }

            const card = document.createElement('div');
            card.className = 'drill-card';
            card.innerHTML = `
                <div><h3>Test ${i}</h3><p style="color:#7f8c8d; font-size:0.8rem; margin:5px 0 0;">${appState.target}</p></div>
                <div><div style="font-size:0.75rem; color:#999; margin-bottom:5px;">${status}</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${progress}%"></div></div></div>
            `;
            card.onclick = () => startExam(i);
            container.appendChild(card);
        }
    }

    async function startExam(round) {
        const cacheId = `${appState.target}-${round}`;
        if (dataStore.examCache[cacheId]) {
            renderQuiz(dataStore.examCache[cacheId].q, round);
            document.getElementById('quiz-overlay').classList.add('active');
        } else {
            await fetchAI_Exam(round, cacheId);
        }
    }

    async function fetchAI_Exam(round, cacheId) {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) { alert('Ë´ãËº∏ÂÖ• API Key'); return; }
        
        document.getElementById('loading').style.display = 'flex';
        
        // --- ÁâπÂåñÊåá‰ª§ÔºöÈáùÂ∞çËà™Á©∫ÂÖ¨Âè∏ÊãõÂãüÁ≠ÜË©¶ ---
        let promptDetail = "";
        if (appState.target === 'Áâ©ÁêÜ') promptDetail = "Level: High School to College Freshman Physics. Topics: Mechanics (Newton's laws, levers, pulleys), Basic Electricity (Ohm's law, circuits), Thermodynamics, Fluid Dynamics (Bernoulli). 10 multiple-choice questions.";
        if (appState.target === 'Êï∏Â≠∏') promptDetail = "Level: High School Math. Topics: Basic Calculus (derivatives), Trigonometry, Vectors, Probability, Arithmetic reasoning. 10 multiple-choice questions.";
        if (appState.target === 'ÈÇèËºØÊ∏¨È©ó') promptDetail = "Generate 10 Logic/IQ Test questions. Topics: Number Series, Verbal Analogies, Logical Reasoning (Syllogism). Avoid image-based puzzles, use text descriptions.";
        if (appState.target === 'Ëà™Á©∫Ëã±Êñá') promptDetail = "Generate 10 TOEIC-style questions but focused on Aviation context (Maintenance, Tools, Safety, Airport). Reading comprehension or Grammar.";

        const prompt = `Role: Airline Recruitment Exam Creator.
        Target: Trainee Aircraft Maintenance Engineer (ÂüπË®ìÈ£õÊ©üÁ∂≠‰øÆÂ∑•Á®ãÂ∏´).
        ${promptDetail}
        Format: JSON Array [{"q":"Question","opts":["A","B","C","D"],"ans":0,"exp":"Explanation in Traditional Chinese"}]`;

        try {
            const res = await callGPT(apiKey, prompt);
            const questions = JSON.parse(res);
            dataStore.examCache[cacheId] = { q: questions, ts: Date.now() };
            saveData();
            renderExamDrills();
            renderQuiz(questions, round);
            document.getElementById('quiz-overlay').classList.add('active');
        } catch(e) { alert("ÁîüÊàêÂ§±ÊïóÔºö" + e.message); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function renderQuiz(questions, round) {
        const container = document.getElementById('quiz-body');
        document.getElementById('quiz-title').innerText = `${appState.target} - Test ${round}`;
        container.innerHTML = '';
        
        questions.forEach((q, idx) => {
            const box = document.createElement('div');
            box.className = 'q-box';
            let html = `<div style="font-weight:bold; margin-bottom:15px; font-size:1.1rem; color:#34495e;">Q${idx+1}. ${q.q}</div>`;
            const isAns = q.userAns !== undefined;
            q.opts.forEach((opt, optIdx) => {
                let cls = 'opt-btn';
                if(isAns) cls += (optIdx === q.ans ? ' correct' : (optIdx === q.userAns ? ' wrong' : ''));
                html += `<button class="${cls}" onclick="checkExamAns(this, ${idx}, ${optIdx}, '${appState.target}-${round}')">${opt}</button>`;
            });
            html += `<div class="explanation" style="display:${isAns?'block':'none'}"><strong>Ëß£ÊûêÔºö</strong>${q.exp}</div>`;
            box.innerHTML = html;
            container.appendChild(box);
        });
    }

    function checkExamAns(btn, qIdx, uIdx, cacheId) {
        const data = dataStore.examCache[cacheId].q[qIdx];
        if (data.userAns !== undefined) return;
        data.userAns = uIdx;
        saveData();
        const parent = btn.parentElement;
        const btns = parent.querySelectorAll('.opt-btn');
        if (uIdx === data.ans) btn.classList.add('correct');
        else { btn.classList.add('wrong'); btns[data.ans].classList.add('correct'); }
        parent.querySelector('.explanation').style.display = 'block';
    }

    // --- Interview Logic ---
    let currentInterviewQ = "";
    async function generateInterviewQ() {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) return alert("Key?");
        document.getElementById('loading').style.display = 'flex';

        // Èù¢Ë©¶Êåá‰ª§ÂÑ™Âåñ
        let detail = "";
        if (appState.target === 'General') detail = "Ask a common HR behavioral question (e.g., Teamwork, Conflict, Why this airline?, Strengths/Weaknesses).";
        if (appState.target === 'Technical') detail = "Ask a basic technical question suitable for Trainee Engineers (e.g., 'How does a jet engine work?', 'What is a torque wrench?', 'Why do you want to be a mechanic?'). Not too advanced.";
        if (appState.target === 'English') detail = "Ask a conversation starter or a simple reading passage to test English speaking ability.";

        const prompt = `Role: Airline Interviewer for Trainee Maintenance Engineer.
        ${detail}
        Output: Question in English followed by Chinese translation.`;

        try {
            const res = await callGPT(apiKey, prompt);
            currentInterviewQ = res;
            document.getElementById('interview-q-text').innerText = res;
            document.getElementById('interview-answer-box').style.display = 'block';
            document.getElementById('interview-feedback').style.display = 'none';
            document.getElementById('interview-input').value = '';
        } catch(e) { alert(e); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    async function analyzeInterview() {
        const ans = document.getElementById('interview-input').value;
        if(!ans) return;
        const apiKey = document.getElementById('api-key').value;
        document.getElementById('loading').style.display = 'flex';
        
        const prompt = `Role: Airline Recruiter.
        Target: Trainee Maintenance Engineer.
        Question: ${currentInterviewQ}
        Answer: ${ans}
        
        Evaluate based on:
        1. Safety awareness (ÈáçË¶Å)
        2. Teamwork & Stability (Ëº™Áè≠ÊÑèÈ°ò)
        3. Logical clarity.
        
        Output: Feedback (Chinese) + Refined Answer (English).`;

        try {
            const res = await callGPT(apiKey, prompt);
            const fbBox = document.getElementById('interview-feedback');
            fbBox.style.display = 'block';
            fbBox.innerHTML = res.replace(/\n/g, '<br>');
        } catch(e) { alert(e); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    async function callGPT(key, prompt) {
        const req = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
            body: JSON.stringify({ model: "gpt-4o-mini", messages: [{role: "user", content: prompt}], temperature: 0.7 })
        });
        const data = await req.json();
        if(data.error) throw new Error(data.error.message);
        return data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
    }

    function closeOverlay(id) {
        document.getElementById(id).classList.remove('active');
        if(id === 'quiz-overlay') renderExamDrills();
    }
</script>

</body>
</html>
