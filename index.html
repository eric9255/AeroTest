<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>èˆªç©ºè·æ¶¯å…¨æ–¹ä½ç‰¹è¨“ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* æ•´åˆç‰ˆé…è‰²ï¼šæ·±ç©ºè— (ç­†è©¦) + è·‘é“ç° (é¢è©¦) + é‡‘è‰² (æ¦®è€€) */
            --sidebar-bg: #1c2331; 
            --sidebar-header: #0d1117;
            --main-bg: #f4f5f7;
            --exam-color: #2c3e50; /* ç­†è©¦ä¸»è‰² */
            --interview-color: #c0392b; /* é¢è©¦ä¸»è‰² (ç†±æƒ…/ç·Šæ€¥) */
            --tech-color: #2980b9; /* æŠ€è¡“ä¸»è‰² */
            --text: #333;
            --accent: #f1c40f;
        }

        /* æ ¸å¿ƒè¨­å®šï¼šé–å®šé é¢ï¼Œé©åˆå¹³æ¿ */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: var(--main-bg); color: var(--text);
        }

        .layout { display: flex; width: 100%; height: 100%; position: relative; }
        .overlay-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; display: none; }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px; background: var(--sidebar-bg); color: #bdc3c7;
            display: flex; flex-direction: column; padding: 0; flex-shrink: 0;
            z-index: 100; transition: transform 0.3s ease;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .sidebar-header { 
            padding: 25px 20px; background: var(--sidebar-header); text-align: center;
            font-weight: bold; font-size: 1.1rem; color: #fff; letter-spacing: 1px; border-bottom: 1px solid #34495e;
        }
        .section-title {
            padding: 15px 20px 5px; font-size: 0.75rem; text-transform: uppercase; 
            color: #5d6d7e; font-weight: bold; letter-spacing: 1px; margin-top: 10px;
        }
        .nav-item { 
            padding: 12px 20px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; 
            font-size: 0.9rem; display: flex; align-items: center; 
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: #fff; font-weight: bold; }
        
        /* ä¸åŒæ¨¡å¼çš„ Active é¡è‰² */
        .nav-item.exam-active { border-left-color: var(--accent); }
        .nav-item.interview-active { border-left-color: var(--interview-color); }
        
        .api-area { padding: 20px; margin-top: auto; border-top: 1px solid #34495e; }
        .api-input { width: 100%; padding: 10px; border-radius: 4px; border: none; background: #0d1117; color: white; border: 1px solid #34495e; }

        /* --- Main Content --- */
        .main-content {
            flex: 1; display: flex; flex-direction: column; width: 100%;
            position: relative; overflow: hidden;
        }
        
        .top-bar {
            background: #fff; height: 60px; padding: 0 20px;
            border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .menu-btn { display: none; font-size: 24px; cursor: pointer; border: none; background: none; color: #333; margin-right: 10px; }
        
        .mode-badge {
            padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; color: white; margin-left: 10px;
        }

        /* Tabs */
        .category-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; -webkit-overflow-scrolling: touch; }
        .category-tabs button {
            background: #fff; border: 1px solid #bdc3c7; padding: 6px 14px;
            cursor: pointer; border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: 0.2s; color: #555;
        }
        .category-tabs button.active { background: var(--exam-color); color: white; border-color: var(--exam-color); }
        /* é¢è©¦æ¨¡å¼ä¸‹çš„ Tab é¡è‰² */
        .interview-mode .category-tabs button.active { background: var(--interview-color); border-color: var(--interview-color); }

        /* Scroll Container */
        .scroll-container {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 20px; padding-bottom: 80px; overscroll-behavior: contain;
        }

        /* --- View: Exam (Grid) --- */
        .drill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .drill-card {
            background: white; border-radius: 8px; padding: 20px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid transparent;
            display: flex; flex-direction: column; justify-content: space-between; height: 110px;
            transition: transform 0.2s;
        }
        .drill-card:hover { transform: translateY(-3px); border-top-color: var(--accent); }
        .progress-bar-bg { width: 100%; height: 4px; background: #eee; margin-top: auto; border-radius: 2px; overflow:hidden; }
        .progress-bar-fill { height: 100%; background: #27ae60; width: 0%; }

        /* --- View: Interview (Card) --- */
        .interview-view { max-width: 800px; margin: 0 auto; display: none; }
        .question-card {
            background: white; border-radius: 8px; padding: 30px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid var(--interview-color);
        }
        .q-text { font-size: 1.3rem; font-weight: bold; margin: 20px 0; color: #333; font-family: "Georgia", serif; }
        .action-btn {
            background: var(--exam-color); color: white; border: none; padding: 12px 25px;
            border-radius: 30px; font-size: 1rem; cursor: pointer; font-weight: bold;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .action-btn.interview-btn { background: var(--interview-color); }
        
        .answer-section { background: white; border-radius: 8px; padding: 20px; display: none; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-box { width: 100%; height: 150px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; margin-bottom: 10px; font-size: 1rem; box-sizing: border-box; }
        
        .feedback-box { background: #fff; border-left: 4px solid var(--accent); padding: 20px; margin-top: 20px; display: none; line-height: 1.6; }

        /* --- Common Elements --- */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: none;
            justify-content: center; align-items: center; z-index: 200; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--exam-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        /* Quiz Overlay (Exam) */
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8f9fa; z-index: 200; display: none; flex-direction: column;
        }
        .quiz-overlay.active { display: flex; animation: slideUp 0.3s ease-out; }
        .quiz-header { padding: 0 20px; height: 60px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .quiz-body { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
        .q-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .opt-btn { width: 100%; text-align: left; padding: 14px; margin-bottom: 10px; border: 1px solid #ddd; background: white; border-radius: 6px; }
        .opt-btn.correct { background: #d4edda; border-color: #27ae60; }
        .opt-btn.wrong { background: #f8d7da; border-color: #c0392b; }
        .explanation { background: #e8f4fd; padding: 15px; margin-top: 10px; border-radius: 6px; display: none; }
        
        /* Essay Overlay */
        .essay-container { display: none; }
        .essay-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #d35400; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; left: -260px; top: 0; }
            .sidebar.open { transform: translateX(260px); }
            .overlay-backdrop.open { display: block; }
            .menu-btn { display: block; }
        }
    </style>
</head>
<body>

<div class="layout">
    <div class="overlay-backdrop" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">âœˆï¸ èˆªç©ºè·æ¶¯ç‰¹è¨“</div>
        
        <!-- ç­†è©¦å€å¡Š -->
        <div class="section-title">ğŸ“ èˆªç©ºç‰¹è€ƒ (ç­†è©¦)</div>
        <div class="nav-item exam-active active" onclick="switchMode('exam', 'æ°‘ç”¨èˆªç©ºæ³•', this)">æ°‘ç”¨èˆªç©ºæ³•</div>
        <div class="nav-item exam-active" onclick="switchMode('exam', 'é£›èˆªç®¡åˆ¶', this)">é£›èˆªç®¡åˆ¶</div>
        <div class="nav-item exam-active" onclick="switchMode('exam', 'èˆªç©ºæ°£è±¡å­¸', this)">èˆªç©ºæ°£è±¡å­¸</div>
        <div class="nav-item exam-active" onclick="switchMode('exam', 'ç©ºæ°£å‹•åŠ›å­¸', this)">ç©ºæ°£å‹•åŠ›å­¸</div>

        <!-- é¢è©¦å€å¡Š -->
        <div class="section-title">ğŸ™ï¸ è·ä½é¢è©¦ (å£è©¦)</div>
        <div class="nav-item interview-active" onclick="switchMode('interview', 'Cabin Crew', this)">ğŸ’ƒ ç©ºæœå“¡ (Cabin)</div>
        <div class="nav-item interview-active" onclick="switchMode('interview', 'Ground Staff', this)">ğŸ« åœ°å‹¤ (Ground)</div>
        <div class="nav-item interview-active" onclick="switchMode('interview', 'Pilot', this)">ğŸ‘¨â€âœˆï¸ æ©Ÿå¸« (Pilot)</div>
        <div class="nav-item interview-active" onclick="switchMode('interview', 'Engineer', this)">ğŸ› ï¸ å·¥ç¨‹å¸« (Tech)</div>

        <div class="api-area">
            <label style="color:#7f8c8d; font-size:0.8rem; font-weight:bold;">API Key</label>
            <input type="password" id="api-key" class="api-input" placeholder="sk-..." onchange="saveKey()">
        </div>
    </aside>

    <main class="main-content" id="main-content">
        <div class="top-bar">
            <div style="display:flex; align-items:center;">
                <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
                <div>
                    <h3 id="top-title" style="margin:0; font-size:1.1rem; display:inline-block;">æ°‘ç”¨èˆªç©ºæ³•</h3>
                    <span id="mode-badge" class="mode-badge" style="background:var(--exam-color)">ç­†è©¦æ¨¡å¼</span>
                </div>
            </div>
            
            <!-- Dynamic Tabs -->
            <div class="category-tabs" id="tabs-container">
                <!-- Javascript will inject buttons here -->
            </div>
        </div>

        <div class="scroll-container">
            
            <!-- 1. ç­†è©¦ä»‹é¢ (Grid) -->
            <div id="exam-view" style="display:block;">
                <div id="drill-list" class="drill-grid"></div>
                <div id="essay-list" class="essay-container">
                    <button onclick="createEssay()" style="width:100%; padding:15px; margin-bottom:20px; background:white; border:2px dashed #999; color:#555; border-radius:8px; font-weight:bold;">+ ç”¢ç”Ÿæ–°ç”³è«–é¡Œ</button>
                    <div id="essay-history"></div>
                </div>
            </div>

            <!-- 2. é¢è©¦ä»‹é¢ (Card) -->
            <div id="interview-view" class="interview-view" style="display:none;">
                <div class="question-card">
                    <div style="color:#999; font-size:0.9rem; margin-bottom:10px;" id="interview-q-type">READY?</div>
                    <div class="q-text" id="interview-q-text">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œé–‹å§‹æ¨¡æ“¬é¢è©¦ã€‚</div>
                    <button class="action-btn interview-btn" onclick="generateInterviewQ()">ğŸ² æŠ½å–é¡Œç›®</button>
                </div>

                <div id="interview-answer-box" class="answer-section">
                    <h4 style="margin-top:0;">Your Answer (Draft/Notes)</h4>
                    <textarea id="interview-input" class="input-box" placeholder="Type or use voice input..."></textarea>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn interview-btn" onclick="analyzeInterview()">âœ¨ æäº¤åˆ†æ</button>
                        <button class="action-btn" style="background:#fff; color:#333; border:1px solid #ccc;" onclick="startVoice()">ğŸ™ï¸ èªéŸ³</button>
                    </div>
                    <div id="interview-feedback" class="feedback-box"></div>
                </div>
            </div>

        </div>

        <!-- Overlays -->
        <div id="loading" class="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-text" style="margin-top:20px; font-weight:bold; color:#555;">AI æ­£åœ¨æº–å‚™è©¦é¡Œ...</p>
        </div>

        <div id="quiz-overlay" class="quiz-overlay">
            <div class="quiz-header">
                <h3 id="quiz-title">æ¨¡æ“¬æ¸¬é©—</h3>
                <button onclick="closeOverlay('quiz-overlay')" style="font-size:1.5rem; background:none; border:none;">âœ•</button>
            </div>
            <div id="quiz-body" class="quiz-body"></div>
        </div>
        
        <div id="essay-overlay" class="quiz-overlay">
            <div class="quiz-header">
                <h3>ç”³è«–é–±å·</h3>
                <button onclick="closeOverlay('essay-overlay')" style="font-size:1.5rem; background:none; border:none;">âœ•</button>
            </div>
            <div id="essay-body" class="quiz-body">
                <div class="q-box" style="font-weight:bold;" id="essay-q-display"></div>
                <textarea id="essay-input" class="input-box" style="height:300px;" placeholder="ä½œç­”å€..."></textarea>
                <button class="action-btn" style="width:100%;" onclick="submitEssay()">æäº¤é–±å·</button>
                <div id="essay-result" class="feedback-box" style="display:none;"></div>
            </div>
        </div>

    </main>
</div>

<script>
    // --- State Management ---
    let appState = {
        mode: 'exam', // 'exam' or 'interview'
        target: 'æ°‘ç”¨èˆªç©ºæ³•', // Subject or Role
        subType: 'basic', // 'basic'/'advanced' or 'behavioral'/'technical'
    };

    let dataStore = {
        examCache: {},
        examEssays: [],
        interviewHistory: []
    };

    const STORAGE_KEY = 'aviation_hub_data';

    // --- Init ---
    window.onload = function() {
        const key = localStorage.getItem('jlpt_api_key');
        if(key) document.getElementById('api-key').value = key;
        
        const savedData = localStorage.getItem(STORAGE_KEY);
        if(savedData) dataStore = JSON.parse(savedData);

        renderTabs();
        renderContent();
    }

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(dataStore)); }
    function saveKey() { localStorage.setItem('jlpt_api_key', document.getElementById('api-key').value.trim()); }
    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.overlay-backdrop').classList.toggle('open');
    }

    // --- Core Navigation ---
    function switchMode(mode, target, btn) {
        appState.mode = mode;
        appState.target = target;
        
        // Update Sidebar UI
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');

        // Reset subType to default
        appState.subType = (mode === 'exam') ? 'basic' : 'behavioral';
        if(target === 'Engineer' && mode === 'interview') appState.subType = 'troubleshooting';

        // Update Top Bar UI
        document.getElementById('top-title').innerText = target;
        const badge = document.getElementById('mode-badge');
        badge.innerText = (mode === 'exam') ? 'ç­†è©¦æ¨¡å¼' : 'é¢è©¦æ¨¡å¼';
        badge.style.background = (mode === 'exam') ? 'var(--exam-color)' : 'var(--interview-color)';
        document.getElementById('main-content').className = (mode === 'interview') ? 'main-content interview-mode' : 'main-content';

        renderTabs();
        renderContent();
        
        if(window.innerWidth <= 768) toggleSidebar();
    }

    function switchTab(type, btn) {
        appState.subType = type;
        document.querySelectorAll('.category-tabs button').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        renderContent();
    }

    function renderTabs() {
        const container = document.getElementById('tabs-container');
        container.innerHTML = '';
        
        if (appState.mode === 'exam') {
            const types = [
                {id: 'basic', name: 'åŸºç¤æ¸¬é©—'},
                {id: 'advanced', name: 'é€²éšæ‡‰ç”¨'},
                {id: 'essay', name: 'ç”³è«–æ¼”ç·´'}
            ];
            types.forEach(t => {
                container.innerHTML += `<button class="${appState.subType === t.id ? 'active' : ''}" onclick="switchTab('${t.id}', this)">${t.name}</button>`;
            });
        } else {
            // Interview Tabs
            let types = [];
            if (appState.target === 'Engineer') {
                types = [
                    {id: 'troubleshooting', name: 'æ•…éšœæ’é™¤'},
                    {id: 'knowledge', name: 'ç³»çµ±çŸ¥è­˜'},
                    {id: 'regulatory', name: 'æ³•è¦æ‰‹å†Š'}
                ];
            } else {
                types = [
                    {id: 'behavioral', name: 'è¡Œç‚ºæƒ…å¢ƒ (STAR)'},
                    {id: 'personal', name: 'å€‹äººé¡Œ'},
                    {id: 'broadcast', name: 'å»£æ’­è©/è‹±æ–‡'}
                ];
            }
            types.forEach(t => {
                container.innerHTML += `<button class="${appState.subType === t.id ? 'active' : ''}" onclick="switchTab('${t.id}', this)">${t.name}</button>`;
            });
        }
    }

    function renderContent() {
        const examView = document.getElementById('exam-view');
        const interviewView = document.getElementById('interview-view');
        const drillList = document.getElementById('drill-list');
        const essayList = document.getElementById('essay-list');

        if (appState.mode === 'exam') {
            interviewView.style.display = 'none';
            examView.style.display = 'block';

            if (appState.subType === 'essay') {
                drillList.style.display = 'none';
                essayList.style.display = 'block';
                renderEssayHistory();
            } else {
                drillList.style.display = 'grid';
                essayList.style.display = 'none';
                renderExamDrills();
            }
        } else {
            examView.style.display = 'none';
            interviewView.style.display = 'block';
            
            // Reset Interview View text
            document.getElementById('interview-q-type').innerText = `${appState.target} - ${appState.subType}`;
            // document.getElementById('interview-q-text').innerText = "é»æ“ŠæŒ‰éˆ•æŠ½å–é¡Œç›®...";
            document.getElementById('interview-answer-box').style.display = 'none';
        }
    }

    // --- Mode A: Exam Logic ---
    function renderExamDrills() {
        const container = document.getElementById('drill-list');
        container.innerHTML = '';
        for(let i=1; i<=10; i++) {
            const cacheId = `${appState.target}-${appState.subType}-${i}`;
            const data = dataStore.examCache[cacheId];
            let progress = 0;
            let status = "æœªé–‹å§‹";
            
            if (data) {
                const answered = data.q.filter(q => q.userAns !== undefined).length;
                progress = (answered / 10) * 100;
                status = progress === 100 ? "å®Œæˆ" : `${answered}/10`;
            }

            const card = document.createElement('div');
            card.className = 'drill-card';
            card.innerHTML = `
                <div><h3>ç¬¬ ${i} å›</h3><p style="color:#7f8c8d; font-size:0.8rem; margin:5px 0 0;">${appState.subType === 'basic' ? 'åŸºç¤é¡Œ' : 'é€²éšé¡Œ'}</p></div>
                <div><div style="font-size:0.75rem; color:#999; display:flex; justify-content:space-between; margin-bottom:5px;"><span>${status}</span></div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${progress}%"></div></div></div>
            `;
            card.onclick = () => startExam(i);
            container.appendChild(card);
        }
    }

    async function startExam(round) {
        const cacheId = `${appState.target}-${appState.subType}-${round}`;
        if (dataStore.examCache[cacheId]) {
            renderQuiz(dataStore.examCache[cacheId].q, round);
            document.getElementById('quiz-overlay').classList.add('active');
        } else {
            await fetchAI_Exam(round, cacheId);
        }
    }

    async function fetchAI_Exam(round, cacheId) {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) { alert('è«‹è¼¸å…¥ API Key'); return; }
        
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-text').innerText = "AI æ­£åœ¨ç”Ÿæˆåœ‹å®¶è€ƒè©¦ç´šè©¦é¡Œ...";

        const prompt = `Role: Examiner for Taiwan Civil Aviation Exam.
        Generate 10 multiple-choice questions for Subject: '${appState.target}'.
        Difficulty: ${appState.subType}.
        Focus on Taiwan regulations (Civil Aviation Act) if applicable.
        JSON Format: [{"q":"...","opts":["A","B","C","D"],"ans":0,"exp":"explanation"}]`;

        try {
            const res = await callGPT(apiKey, prompt);
            const questions = JSON.parse(res);
            dataStore.examCache[cacheId] = { q: questions, ts: Date.now() };
            saveData();
            renderExamDrills(); // update progress bar
            renderQuiz(questions, round);
            document.getElementById('quiz-overlay').classList.add('active');
        } catch(e) { alert(e); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function renderQuiz(questions, round) {
        const container = document.getElementById('quiz-body');
        document.getElementById('quiz-title').innerText = `${appState.target} - ç¬¬ ${round} å›`;
        container.innerHTML = '';
        
        questions.forEach((q, idx) => {
            const box = document.createElement('div');
            box.className = 'q-box';
            let html = `<div style="font-weight:bold; margin-bottom:15px; font-size:1.1rem;">Q${idx+1}. ${q.q}</div>`;
            const isAns = q.userAns !== undefined;
            q.opts.forEach((opt, optIdx) => {
                let cls = 'opt-btn';
                if(isAns) cls += (optIdx === q.ans ? ' correct' : (optIdx === q.userAns ? ' wrong' : ''));
                html += `<button class="${cls}" onclick="checkExamAns(this, ${idx}, ${optIdx}, '${appState.target}-${appState.subType}-${round}')">${opt}</button>`;
            });
            html += `<div class="explanation" style="display:${isAns?'block':'none'}"><strong>è§£æï¼š</strong>${q.exp}</div>`;
            box.innerHTML = html;
            container.appendChild(box);
        });
    }

    function checkExamAns(btn, qIdx, uIdx, cacheId) {
        const data = dataStore.examCache[cacheId].q[qIdx];
        if (data.userAns !== undefined) return; // already answered
        
        data.userAns = uIdx;
        saveData();
        
        // Update UI locally
        const parent = btn.parentElement;
        const btns = parent.querySelectorAll('.opt-btn');
        if (uIdx === data.ans) btn.classList.add('correct');
        else {
            btn.classList.add('wrong');
            btns[data.ans].classList.add('correct');
        }
        parent.querySelector('.explanation').style.display = 'block';
    }

    // --- Mode A: Essay Logic ---
    function renderEssayHistory() {
        const container = document.getElementById('essay-history');
        container.innerHTML = '';
        const list = dataStore.examEssays.filter(e => e.subject === appState.target);
        list.forEach(e => {
            const div = document.createElement('div');
            div.className = 'essay-card';
            div.innerHTML = `<div>${e.q.substring(0,30)}...</div><div style="font-size:0.8rem; color:#999; margin-top:5px;">${e.grade ? 'å¾—åˆ†: '+e.grade.score : 'æœªé–±å·'}</div>`;
            div.onclick = () => openEssay(e.id);
            container.appendChild(div);
        });
    }

    async function createEssay() {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) return alert("Key?");
        document.getElementById('loading').style.display = 'flex';
        
        try {
            const res = await callGPT(apiKey, `Generate ONE Essay Question for Taiwan Civil Aviation Exam, Subject: ${appState.target}. Output ONLY question text.`);
            const newEssay = { id: Date.now(), subject: appState.target, q: res, ans: '', grade: null };
            dataStore.examEssays.unshift(newEssay);
            saveData();
            openEssay(newEssay.id);
        } catch(e) { alert(e); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    let activeEssayId = null;
    function openEssay(id) {
        activeEssayId = id;
        const e = dataStore.examEssays.find(x => x.id === id);
        document.getElementById('essay-q-display').innerText = e.q;
        document.getElementById('essay-input').value = e.ans;
        
        const resDiv = document.getElementById('essay-result');
        if(e.grade) {
            resDiv.style.display = 'block';
            resDiv.innerHTML = `<h2 style="color:#d35400">${e.grade.score}åˆ†</h2><p>${e.grade.comment}</p><div style="background:#eee; padding:10px; margin-top:10px;">${e.grade.model}</div>`;
        } else {
            resDiv.style.display = 'none';
        }
        document.getElementById('essay-overlay').classList.add('active');
    }

    async function submitEssay() {
        const ans = document.getElementById('essay-input').value;
        if(!ans) return;
        const e = dataStore.examEssays.find(x => x.id === activeEssayId);
        e.ans = ans;
        saveData();

        const apiKey = document.getElementById('api-key').value;
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-text').innerText = "AI é–±å·ä¸­...";

        try {
            const prompt = `Grade this essay for Taiwan Civil Aviation Exam. Question: ${e.q}. Answer: ${ans}. Return JSON: {"score": 0-25, "comment": "string", "model": "model_answer"}`;
            const res = await callGPT(apiKey, prompt);
            e.grade = JSON.parse(res);
            saveData();
            openEssay(activeEssayId);
            renderEssayHistory();
        } catch(err) { alert(err); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }


    // --- Mode B: Interview Logic ---
    let currentInterviewQ = "";

    async function generateInterviewQ() {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) return alert("Key?");
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-text').innerText = "é¢è©¦å®˜æ­£åœ¨ç¿»é–±å±¥æ­·...";

        // Engineer Prompts differ from Cabin Crew
        let detail = "";
        if (appState.target === 'Engineer') {
            detail = `Role: Airline Chief Engineer. Ask a ${appState.subType} question. Include technical scenarios.`;
        } else {
            detail = `Role: Airline Recruiter. Ask a ${appState.subType} question for ${appState.target}.`;
        }

        const prompt = `${detail} Output: Question in English, then Chinese translation. Plain text.`;

        try {
            const res = await callGPT(apiKey, prompt);
            currentInterviewQ = res;
            document.getElementById('interview-q-text').innerText = res;
            document.getElementById('interview-answer-box').style.display = 'block';
            document.getElementById('interview-feedback').style.display = 'none';
            document.getElementById('interview-input').value = '';
        } catch(e) { alert(e); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    async function analyzeInterview() {
        const ans = document.getElementById('interview-input').value;
        if(!ans) return;
        const apiKey = document.getElementById('api-key').value;
        document.getElementById('loading').style.display = 'flex';
        
        const prompt = `Evaluate this answer for ${appState.target} interview. Question: ${currentInterviewQ}. Answer: ${ans}. 
        Provide Feedback (Chinese) and a Better Version (English).`;

        try {
            const res = await callGPT(apiKey, prompt);
            const fbBox = document.getElementById('interview-feedback');
            fbBox.style.display = 'block';
            fbBox.innerHTML = res.replace(/\n/g, '<br>');
        } catch(e) { alert(e); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }
    
    function startVoice() {
        if (!('webkitSpeechRecognition' in window)) return alert("è«‹ä½¿ç”¨ Chrome");
        const r = new webkitSpeechRecognition();
        r.lang = 'en-US';
        r.start();
        r.onresult = (e) => { document.getElementById('interview-input').value += e.results[0][0].transcript + " "; }
    }


    // --- Helper: API Call ---
    async function callGPT(key, prompt) {
        const req = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [{role: "user", content: prompt}],
                temperature: 0.7
            })
        });
        const data = await req.json();
        if(data.error) throw new Error(data.error.message);
        return data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
    }

    function closeOverlay(id) {
        document.getElementById(id).classList.remove('active');
        if (id === 'essay-overlay') renderEssayHistory();
        if (id === 'quiz-overlay') renderExamDrills();
    }
</script>

</body>
</html>
